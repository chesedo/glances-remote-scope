var scopes = require('unity-js-scopes');

var FilesystemsCategory = function() {
    this.template = {
        "schema-version": 1,
        "template": {
            "category-layout": "vertical-journal",
            "collapsed-rows": 2,
            "card-size": "large",
        },
        "components": {
            "title": "title",
            "emblem": "emblem",
            "attributes": "attributes"
        }
    }
}

FilesystemsCategory.prototype.createCategory = function(search_reply, qs) {
    var category_renderer = new scopes.lib.CategoryRenderer(JSON.stringify(this.template));
    var category = search_reply.register_category("fs", "Filesystems", "", category_renderer);

    data.getValue("fs").forEach(function(fs) {
        if (qs === "" || fs["mnt_point"].search(qs) !== -1 || fs["device_name"].search(qs) !== -1) {
            search_reply.push(this.createCard(fs, category))
        }
    }.bind(this));
}

FilesystemsCategory.prototype.createCard = function (fs, category) {
    var categorised_result = new scopes.lib.CategorisedResult(category);
    var table = [
                ["Free", data.convertByte(fs["free"])],
                ["Used", data.convertByte(fs["used"]) + " (" + fs["percent"] + "%)"],
                ["Size", data.convertByte(fs["size"])],
                ["Device", fs["device_name"]],
                ["Type", fs["fs_type"]]
            ];
    var attributes = [
                {"value": fs["device_name"]},
                {"value": fs["percent"] + "%"},
            ];

    categorised_result.set("resultCategory", "fs");
    categorised_result.set_uri(fs["device_name"]);
    categorised_result.set_title(fs["mnt_point"]);
    categorised_result.set("emblem", data.getFSEmblem(fs["percent"]));
    categorised_result.set("table", table);
    categorised_result.set("attributes", attributes);

    return categorised_result;
}

FilesystemsCategory.prototype.createPreview = function(preview_reply) {
    var layout1col = new scopes.lib.ColumnLayout(1);
    layout1col.add_column(["header", "table"]);

    preview_reply.register_layout([layout1col]);

    var header = new scopes.lib.PreviewWidget("header", "header");
    header.add_attribute_mapping("title", "title");
    header.add_attribute_mapping("emblem", "emblem");

    var table = new scopes.lib.PreviewWidget("table", "table");
    table.add_attribute_mapping("values", "table");

    preview_reply.push([header, table]);
    preview_reply.finished();
}

exports.FilesystemsCategory = FilesystemsCategory;
